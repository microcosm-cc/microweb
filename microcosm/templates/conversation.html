{% extends 'base.html' %}

{% block breadcrumb %}
	<ol class="breadcrumb">
		<li><a href="/">Home</a></li>
		<li><a href='{{ content.meta.links.microcosm.href|slice:"7:" }}/'>{{ content.meta.links.microcosm.title }}</a></li>
		<li class="active"><a href='{{ content.meta.links.self.href|slice:"7:" }}'>{{ content.title }}</a></li>
	</ol>
{% endblock %}

{% block ga %},'dimension2': '{{ content.meta.created_by.id }}'
			,'dimension3': '{{ content.microcosm_id }}'{% endblock%}

{% block content %}
	<h1 id="conversation_title">{{ content.title }}</h1>
	<br />
	{% include "comments_block.html" %}

{% endblock %}

{% block sidebar %}
	{% if user %} {% if not content.meta.flags.iswatched %}
	<form method="POST" action="" id="subscribe_form">
		{% csrf_token %}
		<input type="hidden" name="alert_type_id" value="1">
		<input class="btn btn-default btn-block" id="watch" type="submit" value="Watch this Conversation" />
		<p/>
	</form>
	{% else %}
	<p class="text-muted">You are watching this conversation</p>
	{% endif %}{% endif %}
	<p class="muted hidden-xs">
		Created by <a href="/profiles/{{content.meta.created_by.id}}/">{{ content.meta.created_by.profile_name|truncatechars:25 }}</a><br />
		<time datetime="{{ content.meta.created|date:"c" }}"></time>
	</p>

	{% if content.meta.permissions.update %}
	<p class="hidden-xs">
		<a id="edit_conversation" href="{% url 'edit-conversation' content.id %}" >Edit conversation</a>

		{% if content.meta.permissions.delete %}
			<form method="POST" action="{% url 'delete-conversation' content.id %}" id="conversation_delete_form" class="hidden-xs">
				{% csrf_token %}
				<a id="delete-conversation" href="#" onClick="if (confirm('Delete is a one-way action, are you sure?')) {$('#conversation_delete_form').submit()}" class="text-danger">Delete conversation</a>
			</form>
		{% endif %}
	</p>
	{% endif %}

{% endblock %}

{% block js %}

	{% if user %}
	<script src="{{ STATIC_URL }}js/md5.min.js"></script>
	<script type="text/javascript">
		function isEmpty(e) {
			return (e.val().trim() == '');
		}
		function checkEmpty(e) {
			if (isEmpty($(e))) {
				addError($(e))
			} else {
				removeError($(e))
			}
		}
		function addError(e) {
			e.parent().addClass('has-error')
		}
		function removeError(e) {
			e.parent().removeClass('has-error')
		}

		$('#id_markdown').on('change', function() {
			checkEmpty(this);
		}).on('blur', function() {
			checkEmpty(this);
		});

		$('#commentForm').submit(function() {
			if (isEmpty($('#id_markdown'))) {
				addError($('#id_markdown'))
				return false;
			}

			// Client-side dupe check
			md5 = hex_md5($('#id_markdown').val())
			if (this.md5 && this.md5 == md5) {
				return false
			}
			this.md5 = md5;

			return true;
		});

		$(document).ready(function() {
			$('#id_markdown').addClass('form-control').parent().addClass('form-group');
		});
	</script>
	{% endif %}
{% endblock %}
