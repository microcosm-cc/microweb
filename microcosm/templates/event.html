{% extends 'base.html' %}

{% block css %}
		<!-- Leaflet -->
		<link href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.6.4/leaflet.css" rel="stylesheet" type="text/css" />
		<!--[if lte IE 8]>
			<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.6.4/leaflet.ie.min.css" />
		<![endif]-->
{% endblock %}

{% block breadcrumb %}
	<ol class="breadcrumb">
		<li><a href="/">Home</a></li>
		<li><a href='{{ content.meta.links.microcosm.href }}/'>{{ content.meta.links.microcosm.title }}</a></li>
		<li class="active"><a href='{{ content.meta.links.self.href }}'>{{ content.title }}</a></li>
	</ol>
{% endblock %}

{% block ga %},'dimension2': '{{ content.meta.created_by.id }}'
			,'dimension3': '{{ content.microcosm_id }}'{% endblock%}

{% block content %}
	<h1 id="event_title">{{content.title}}</h1>


	<div class="row">
		<div class="col col-sm-4 col-xs-6">
			<p class="text-muted">Where</p>
		</div>
		<div class="col col-sm-4 col-xs-10">
			<p id="where">{% if content.where %}{{ content.where }}{% else %}To be determined.{% endif %}</p>
		</div>
		<div class="col col-sm-8 col-xs-16 pull-right">
			<div id="map" style="height:366px"></div>
			<div id="maplinks" style="display:none;"></div>
		</div>

		<div class="row col col-sm-8 col-xs-16">
			<div class="col col-sm-8 col-xs-6">
				<p class="text-muted">Starts</p>
			</div>
			<div class="col col-sm-8 col-xs-10">
				<p style="padding-left:6px;"><time id="when" format="LLL" datetime="{{ content.when|date:"c\Z" }}" duration="{{content.duration}}">{{content.when}}</time></p>
			</div>
		</div>

		<div class="row col col-sm-8 col-xs-16">
			<div class="col col-sm-8 col-xs-6">
				<p class="text-muted">Ends</p>
			</div>
			<div class="col col-sm-8 col-xs-10">
				<p style="padding-left:6px;"><time id="ends" format="LLL"></time></p>
			</div>
		</div>

		<div class="row col col-sm-8 col-xs-16">
			<div class="col col-sm-8 col-xs-6">
				<p class="text-muted">Attendees</p>
			</div>
			<div class="col col-sm-8 col-xs-10">
				<p id="rsvp_limit" style="padding-left:6px;">{{ content.rsvp_attend }}</p>
			</div>
		</div>

		{% if content.rsvp_limit %}
		<div class="row col col-sm-8 col-xs-16">
			<div class="col col-sm-8 col-xs-6">
				<p class="text-muted">Attendee Limit</p>
			</div>
			<div class="col col-sm-8 col-xs-10">
				<p id="rsvp_limit" style="padding-left:6px;">{{ content.rsvp_limit }}</p>
			</div>
		</div>
		{% endif %}

		{% if content.rsvp_spaces %}
		<div class="row col col-sm-8 col-xs-16">
			<div class="col col-sm-8 col-xs-6">
				<p class="text-muted">Spaces Left</p>
			</div>
			<div class="col col-sm-8 col-xs-10">
				<p id="spaces_left" style="padding-left:6px;">{{ content.rsvp_spaces }}</p>
			</div>
		</div>
		{% endif %}
	</div>

	<div class="row">
		<h4>Are you coming?</h4>
		{% if user %}
			{% if content.rsvp_limit == 0 or content.rsvp_limit > content.rsvp_attend %}
			<form method="POST" action="{% url 'rsvp-event' content.id %}" style="display:inline-block;">
				{% csrf_token %}
				<input type="hidden" name="rsvp" value="yes" />
				<input id="rsvp_yes" type="submit" value="Count me in" class="btn btn-primary">
			</form>
			{% endif %}

			<form method="POST" action="{% url 'rsvp-event' content.id %}" style="display:inline-block;">
				{% csrf_token %}
				<input type="hidden" name="rsvp" value="no" />
				<input id="rsvp_no" type="submit" value="Can't make it" class="btn btn-default">
			</form>
		{% endif %}
	</div>

	<h4>Who's going?</h4>
	{# Iterating the attendees four times is only temporary, they'll be split into different collections in future. #}
	<p><strong>Confirmed</strong></p>
	<p>
		{% for item in attendees.items.items %}
			{% if item.rsvp == "yes" %}
				<a href="/profiles/{{ item.profile_id }}/">{{ item.profile.profile_name|truncatechars:25 }}</a>
			{% endif %}
		{% endfor %}
	</p>

	<hr />
	{% include "comments_block.html" %}
{% endblock %}

{% block sidebar %}
	<p class="muted hidden-xs">
		Created by <a href="{% url 'single-profile' content.meta.created_by.id %}" id="created_by">{{ content.meta.created_by.profile_name|truncatechars:25 }}</a><br />
		<time datetime="{{ content.meta.created|date:"c" }}"></time>
	</p>
	{% if user %} {% if not content.meta.flags.watched %}
	<form method="POST" action="" id="subscribe_form">
		{% csrf_token %}
		<input type="hidden" name="update_type_id" value="1">
		<input class="btn btn-default btn-block" id="watch" type="submit" value="Watch this Event" />
		<p/>
	</form>
	{% else %}
	<p class="text-muted">You are <a href="/watchers/">watching</a> this event and you will receive <a href="/updates/">updates</a>.</p>
	{% endif %}{% endif %}

	{% if content.meta.permissions.update %}
	<p class="hidden-xs">
		<a id="edit_event" href="{% url 'edit-event' content.id %}">Edit event</a>

		{% if content.meta.permissions.delete %}
			<form method="POST" action="{% url 'delete-event' content.id %}" id="event_delete_form" class="hidden-xs">
				{% csrf_token %}
				<a id="delete-event" href="#" onClick="if (confirm('Delete is a one-way action, are you sure?')) {$('#event_delete_form').submit()}" class="text-danger">Delete event</a>
			</form>
		{% endif %}
	</p>
	{% endif %}

{% endblock %}

{% block js %}
	<!-- Leaflet -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.6.4/leaflet.js"></script>
	<script src="https://maps.google.com/maps/api/js?v=3.2&key=AIzaSyAQiDoalPm41b4e-tuIecK39xoaPPV5k3E&sensor=false"></script>

	<!-- Microcosm event -->
    {% if user %}
    <script src="{{ STATIC_URL }}js/md5.min.js"></script>
    {% endif %}
	<script src="{{ STATIC_URL }}js/m-event.js" type="text/javascript"></script>

	<script type="text/javascript">
		$(document).ready(function() {
			console.log($('#when').attr('datetime'))
			console.log($('#when').attr('duration'))
			showEndDate($('#when').attr('datetime'), $('#when').attr('duration'));

			restoreLocationState(
				Number('{{ content.lat }}'),
				Number('{{ content.lon }}'),
				[
					[Number('{{ content.north }}'), Number('{{ content.west }}')],
					[Number('{{ content.south }}'), Number('{{ content.east }}')]
				]
			);
		});


		function isEmpty(e) {
			return (e.val().trim() == '');
		}
		function checkEmpty(e) {
			if (isEmpty($(e))) {
				addError($(e))
			} else {
				removeError($(e))
			}
		}
		function addError(e) {
			e.parent().addClass('has-error')
		}
		function removeError(e) {
			e.parent().removeClass('has-error')
		}

		$('#id_markdown').on('change', function() {
			checkEmpty(this);
		}).on('blur', function() {
			checkEmpty(this);
		});

		$('#commentForm').submit(function() {
			if (isEmpty($('#id_markdown'))) {
				addError($('#id_markdown'))
				return false;
			}

			// Client-side dupe check
			md5 = hex_md5($('#id_markdown').val())
			if (this.md5 && this.md5 == md5) {
				return false
			}
			this.md5 = md5;

			return true;
		});


		$(document).ready(function() {
			$('#id_markdown').addClass('form-control').parent().addClass('form-group');
		});
	</script>
{% endblock %}
